<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sealll.mapper.PostMapper">
    <sql id="baseColume">
        p.p_id,title,time,content,description
    </sql>
    <sql id="simpleColume">
        p.p_id,title,time,description
    </sql>
     <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 28 22:23:38 CST 2021.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
    <sql id="plainPost">
        select <include refid="baseColume"/> from post p
    </sql>
    <sql id="postWithAuthor">
        select <include refid="baseColume"/> ,p.uid as uid,username
        from post p inner join `User` u
        on p.uid = u.uid
    </sql>
    <sql id="postWithTags">
        select p.p_id,title,time,content , t.tag ,t.tagname
        from post p
        left join tag_post tp on tp.p_id = p.p_id
        left join tag t on tp.tag = t.tag
    </sql>
    <sql id="postTerminal">
        select <include refid="baseColume"></include>, t.tag,t.tagname,u.uid,u.username
        from post p inner join `User` u
        on p.uid = u.uid
        left join tag_post tp on tp.p_id = p.p_id
        left join tag t on tp.tag = t.tag
    </sql>
    <sql id="postTerminalWithCount">
        select <include refid="baseColume"></include>, t.tag,t.tagname,u.uid,u.username,(select count(re_id)
        from post p1 LEFT JOIN reply re on p1.p_id=re.p_id
        where p1.p_id=p.p_id
        ) as reply,(select count(f.fav_id)
        from post p2 LEFT JOIN fav f on p2.p_id=f.p_id
        where p2.p_id=p.p_id
        ) as faved
        from post p left join tag_post tp on p.p_id=tp.p_id
        left join tag t on tp.tag=t.tag
        inner join `User` u on u.uid=p.uid
    </sql>
    <resultMap id="plainPost" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="content" column="content"></result>
        <result property="description" column="description"></result>
    </resultMap>
    <resultMap id="postWithAuthor" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="content" column="content"></result>
        <result property="description" column="description"></result>
        <association property="author" javaType="com.sealll.application.user.bean.User">
            <id property="uid" column="uid"></id>
            <result property="username" column="username"></result>
        </association>
    </resultMap>
    <resultMap id="postWithTags" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="content" column="content"></result>
        <result property="description" column="description"></result>
        <collection property="tags" ofType="com.sealll.application.tag.bean.Tag">
            <id property="tag" column="tag"></id>
            <result property="tagname" column="tagname"></result>
        </collection>
    </resultMap>
    <resultMap id="postTerminal" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="content" column="content"></result>
        <result property="description" column="description"></result>
        <association property="author" javaType="com.sealll.application.user.bean.User">
            <id property="uid" column="uid"></id>
            <result property="username" column="username"></result>
        </association>
        <collection property="tags" ofType="com.sealll.application.tag.bean.Tag">
            <id property="tag" column="tag"></id>
            <result property="tagname" column="tagname"></result>
        </collection>
    </resultMap>
    <resultMap id="postTerminalWithCount" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="content" column="content"></result>
        <result property="description" column="description"></result>
        <result property="reply" column="reply"></result>
        <result property="faved" column="faved"></result>
        <association property="author" javaType="com.sealll.application.user.bean.User">
            <id property="uid" column="uid"></id>
            <result property="username" column="username"></result>
        </association>
        <collection property="tags" ofType="com.sealll.application.tag.bean.Tag">
            <id property="tag" column="tag"></id>
            <result property="tagname" column="tagname"></result>
        </collection>
    </resultMap>

    <resultMap id="plainPostDesc" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="description" column="description"></result>
    </resultMap>
    <resultMap id="postWithAuthorDesc" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="description" column="description"></result>
        <association property="author" javaType="com.sealll.application.user.bean.User">
            <id property="uid" column="uid"></id>
            <result property="username" column="username"></result>
        </association>
    </resultMap>
    <resultMap id="postWithTagsDesc" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="description" column="description"></result>
        <collection property="tags" ofType="com.sealll.application.tag.bean.Tag">
            <id property="tag" column="tag"></id>
            <result property="tagname" column="tagname"></result>
        </collection>
    </resultMap>
    <resultMap id="postTerminalDesc" type="com.sealll.application.post.bean.Post">
        <id property="pId" column="p_id"></id>
        <result property="title" column="title"></result>
        <result property="time" column="time"></result>
        <result property="description" column="description"></result>
        <association property="author" javaType="com.sealll.application.user.bean.User">
            <id property="uid" column="uid"></id>
            <result property="username" column="username"></result>
        </association>
        <collection property="tags" ofType="com.sealll.application.tag.bean.Tag">
            <id property="tag" column="tag"></id>
            <result property="tagname" column="tagname"></result>
        </collection>
    </resultMap>

    <select id="getPlainPostByPid" resultMap="plainPost">
        <include refid="plainPost"></include>
        where p_id = #{pid}
    </select>
    <select id="getPostWithAuthorByPid" resultMap="postWithAuthor">
        <include refid="postWithAuthor"></include>
        where p.p_id = #{pid}
    </select>
    <select id="getPostWithTagsByPid" resultMap="postWithTags">
        <include refid="postWithTags"></include>
        where p.p_id = #{pid}
    </select>
    <select id="getPostTerminalByPid" resultMap="postTerminal">
        <include refid="postTerminal"></include>
        where p.p_id = #{pid}
    </select>
    <select id="getPostTerminalWithCountByPid" resultMap="postTerminalWithCount">
        <include refid="postTerminalWithCount"></include>
        where p.p_id=#{pid}
    </select>

    <!-- ***************** -->
    <select id="getPlainPostByExample" resultMap="plainPostDesc">
        <include refid="plainPost"></include>
        <if test="_parameter != null">
            <include refid="Example_Where_Clause" />
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
    </select>
    <select id="getPostWithAuthorByExample" resultMap="postWithAuthorDesc">
        <include refid="postWithAuthor"></include>
        <if test="_parameter != null">
            <include refid="Example_Where_Clause" />
        </if>
        <if test="orderByClause != null">
            order by #{orderByClause}
        </if>
    </select>
    <select id="getPostWithTagsByExample" resultMap="postWithTagsDesc">
        <include refid="postWithTags"></include>
        <if test="_parameter != null">
            <include refid="Example_Where_Clause" />
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
    </select>
    <select id="getPostTerminalByExample" resultMap="postTerminalDesc">
        <include refid="postTerminal"></include>
        <if test="_parameter != null">
            <include refid="Example_Where_Clause" />
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
    </select>
    <select id="getPostTerminalWithCountByExample" resultMap="postTerminalWithCount">
        <include refid="postTerminalWithCount"></include>
        <if test="_parameter != null">
            <include refid="Example_Where_Clause" />
        </if>
        <if test="orderByClause != null">
            order by ${orderByClause}
        </if>
    </select>

    <select id="getPostByTag" resultMap="postTerminalDesc">
        <include refid="postTerminal"></include>
        where t.tag = #{tid}
    </select>

    <!--public boolean insertPost(Post post);-->
    <insert id="insertPost" useGeneratedKeys="true" keyProperty="pId">
        <selectKey keyColumn="pid" keyProperty="pId" order="AFTER" resultType="java.lang.String">
            select p_id
            from post
            where uid = #{uid} and title = #{title}
            order by time desc
            limit 1
        </selectKey>
        insert into post (p_id,uid,title,content,time,description)
        values
        ('',#{uid},#{title},#{content},
        <if test="time != null">
            #{time}
        </if>
        <if test="time == null">
            null
        </if>,
            #{description}
        )
    </insert>
    <!--public boolean insertTags(Post post);-->
    <insert id="insertTags">
        insert into tag_post values
        <foreach collection="tags" item="tag" separator=",">
            ('',#{pId},#{tag.tag})
        </foreach>
    </insert>

    <update id="updateSelective" parameterType="com.sealll.application.post.bean.Post">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Apr 28 22:23:38 CST 2021.
        -->
        update post
        <set>
            <if test="title != null">
                title = #{title,jdbcType=CHAR},
            </if>
            <if test="content != null">
                content = #{content,jdbcType=LONGVARBINARY},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
        </set>
        where p_id = #{pId,jdbcType=CHAR}
    </update>
    <delete id="deleteAllTags">
        delete from tag_post
        where p_id = #{pId}
    </delete>

    <delete id="deletePostByPid">
        delete from post
        where p_id = #{pId}
    </delete>
</mapper>